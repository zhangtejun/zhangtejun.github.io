---
layout: post
title:  "网络"
date:   2019-08-03 20:53:01
author: zhangtejun
categories: Java
---
##### TCP/IP
TCP/IP体系结构即TCP/IP的4层协议：
* 应用层：各种应用层协议（HTTP,FTP,SMTP等）
* 传输层：传输层为相互通信的应用进程提供逻辑通信。主要协议TCP,UDP。应用所有的应用进程都可以通过传输层传送到网络层（IP层）
  即复用，传输层从IP层收到数据必须交付给相应的应用层，即分用。为了能够使运行在不同操作系统的进程可以相互通信，必须使用一种和系统无光的方法
  来标志进程，即再传输层使用协议端口号来绝决这个问题。
  每一条TCP连接有2个端点，该端点不是主机也不是ip,不是进程，也不是传输层的协议端口，TCP的端点叫套接字（socket）或者插口。端口好拼接到IP地址
  构成套接字。

* 网络层：实现2个系统间数据的透明传输，即寻址，路由等，网际IP协议通常使用ARP协议，ICMP,IGMP通常使用IP协议，向上层提供简单灵活，无连接的数据交付服务，可靠性有传输层负责。

传输控制协议TCP：提供可靠的服务，通过TCP传输的数据可以无差错，不重复，不丢失，并且按序到达。

TCP发送的报文是交给IP层传送的，IP层不提供可靠的传送，因此TCP必须采取相应的措施来使2个传输层的信道变得可靠。

理想传输条件：传输信道不产生差错，不管发送方以多大速度发送数据，接收方总来的及处理。

在理想传输条件下，不需要采取任何措施就可以保证传输的可靠性。

实际的网络中并不具备以上2个条件，都是我们可以提供一些可靠传输协议，当出现差错时让发送方重传，接收方来不及接收时，让发送方降低发送速率。

**停止等待协议**
全双工信道的通信双方即是发送方也是接收方，”停止等待“就是没发送完一个分组就停止发送，等待对方确认，确认后再发下一个分组。

优缺点：传输简单，但是信道利益率低，为了提高效率，发送方可以不使用停止等待协议，而采用流水线传输。即发送方一次发送多个分组，

使用流水先传输时，需要使用连续ARQ协议和滑动窗口协议。

发送方维持发送窗口，位于窗口内的分组可以连续发送出去，而不需要等待对方确认。
连续ARQ协议规定：发送方每收到一个确认，就把发送窗口向前移动一个分组的位置。接收方一般采用累加确定的方式，即接收方不必对收到的分组进行每一个确认
而是收到几个分组后，对按序到达的最后一个分组发送确认，表示改组之前的所有分组已正确收到。

累计确认的优缺点：容易实现，即使确定丢失也不必重传。但是不能向发送方反应已经正确接收到的所有分组信息。

TCP报文段的首部格式：一个TCP报文包括首部和数据2部分，而TCP的全部功能都体现在它的首部各字段中，首部的前20个字节是固定的，
后面有4n个字节是根据需要而增加的选项。因此TCP首部最小长度是20字节。

5行每行4字节，

* 源端口和目标端口各2字节，

* 序号4字节：指发送数据的位置，就累加该数据字节数大小，例如一段报文的序号字段是301，而携带数据共100字节，那么本报文最后一个字节序号是400。下一个报文
段的数据序号应该从401开始。

* 确认号：4字节，是期望收到对方下一个报文段的第一个数据字节的序号，例如B正确收到A发送过来的一个报文段，其序号是501，数据长度为200字节（501-700）
，这表明B正确接收到了A发送的到序号700为止的数据。因此B期望收到A下一个数据序号是701，于是B在发送给A的确认报文中把确认号设置为701。

* 第3行
   * 数据偏移：4位，实际上是指出TCP报文段的首部长度，因为首部中还有长度不明确的选项字段，该字段是必要的，
      它指出TCP报文段的数据起始出距离TCP报文段的起始处有多远。
   * 保留：占6位，保留为今后使用，暂时应设为0；
   * 控制位：占6位
     * URG：紧急，当URG=1时，说明紧急指针有效，它表面报文中有紧急数据，应尽快传递（高优先级数据），发送方TCP把紧急数据插入到本报文的最前面
       紧急后面仍然是普通数据。比如一些取消程序运行的指令等。
     * ACK：确认，当ACK=1时，确认字段才有效。TCP规定在连接建立之后，所有的传送报文都必须设置为1。
     * PSH：推送，2个进程通信时，有时一端的应用希望在键入下一个命令后就立即收到对方的响应，发送方将PSH设置为1，接收方收到后将尽快交付给接收应用程序
            而不再等待整个缓冲区都填满了后在往上交付。
     * RST：复位，当RST=1时，表明TCP连接出现了严重的差错（主机崩溃或其他原因），必须释放连接，然后重新建立连接。
     * SYN：同步，在连接建立时用来同步序号。
     * FIN：终止，用来释放连接，当FIN=1时，表明数据传输完成，并要求释放连接。
   * 窗口：2字节，指发送本报文段的一方的接收窗口（不是自己的发送窗口），该值告诉对方：从本报文段首部中的确认号算起，接收方目前允许
     对方发送的数据量，原因是因为接收方的数据缓存空间是有限的。该值经常动态变化。
* 校验和紧急指针，各占2字节，校验和检验的范围包括首部和数据2部分；紧急指针在URG=1时有效，它指出本报文中的紧急数据的字节数。

* 选项（第6行 如果有）：长度可变，最长40字节。当没有使用选项时，TCP首部就20字节。
   TCP最初只规定一种选项，即最大报文长度MSS，MSS为每个TCP报文中数据字段的最大长度。后续增加窗口扩大选项，时间戳等选项。
* 数据（最后一行）：

**以字节流为单位的滑动窗口**
1. 虽然A的发送窗口是根据B的接收窗口设置的，但是在同一时刻并不能保证窗口总是保存一样的大小。
2. 对于不安序到达的数据如何处理，TCP通常把到达的数据先临时放到接收窗口中，等字节流中所缺少的字节收到后，再按序交付给上层应用。
3. TCP要求接收方有累计确认功能，这样可以减少开销。

**超时重传**
TCP采用自适应算法，它记录报文的发出时间，以及收到相应确认的时间，时间差就是报文的往返时间RTT。TCP保留RTT的一个加权平均往返时间，
超时重传时间RTO应略大于加权平均往返时间。

**TCP流量控制**
